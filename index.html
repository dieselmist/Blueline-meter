<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Blueline Meter</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
  --blue: #4fc3f7;
  --blue-dim: #0277bd;
  --blue-glow: rgba(79,195,247,0.25);
  --bg: #080b0f;
  --surface: #0d1117;
  --surface2: #111620;
  --border: rgba(255,255,255,0.07);
  --text: #d6eaf8;
  --muted: #3a4255;
  --green: #2ecc71;
  --red: #e74c3c;
  --amber: #f5a623;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

html, body {
  width: 100%; height: 100%; overflow: hidden;
  background: var(--bg);
  font-family: 'Rajdhani', sans-serif;
  color: var(--text);
}

/* â”€â”€ Layout â”€â”€ */
.container {
  display: flex;
  width: 100vw; height: 100vh;
}

/* â”€â”€ Left panel â€” meter â”€â”€ */
.meter-panel {
  width: 380px;
  min-width: 380px;
  height: 100%;
  background: var(--bg);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  padding: 14px 12px;
  background-image: radial-gradient(ellipse at 50% 0%, rgba(79,195,247,0.05) 0%, transparent 60%);
}

/* â”€â”€ Right panel â€” map â”€â”€ */
.map-panel {
  flex: 1;
  height: 100%;
  position: relative;
}
#map {
  width: 100%; height: 100%;
  background: #0a0e14;
}

/* â”€â”€ Header â”€â”€ */
.header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 12px; padding-bottom: 10px;
  border-bottom: 1px solid var(--border);
}
.brand { display: flex; align-items: center; gap: 8px; }
.brand-icon {
  width: 30px; height: 30px; border-radius: 7px;
  background: linear-gradient(135deg, #4fc3f7, #0277bd);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; box-shadow: 0 3px 10px rgba(79,195,247,0.3);
}
.brand-name { font-size: 15px; font-weight: 700; letter-spacing: 2px; color: var(--text); }
.brand-sub { font-size: 9px; letter-spacing: 3px; color: var(--muted); }
.status-pill {
  padding: 4px 10px; border-radius: 20px; font-size: 10px;
  font-weight: 600; letter-spacing: 2px;
  background: rgba(58,66,85,0.3); border: 1px solid var(--border); color: var(--muted);
  transition: all 0.4s;
}

/* â”€â”€ Fare â”€â”€ */
.fare-wrap {
  background: linear-gradient(145deg, #0f1219, #0b0e14);
  border: 1px solid rgba(79,195,247,0.15);
  border-radius: 16px; padding: 14px 18px 12px;
  margin-bottom: 10px; position: relative; overflow: hidden;
  box-shadow: 0 6px 30px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.04);
}
.fare-wrap::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, var(--blue), transparent); opacity: 0.4;
}
.fare-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.fare-label { font-size: 9px; letter-spacing: 4px; color: var(--muted); text-transform: uppercase; }
.tariff-badge {
  font-size: 9px; letter-spacing: 2px; padding: 2px 7px; border-radius: 4px;
  background: rgba(79,195,247,0.1); border: 1px solid rgba(79,195,247,0.3); color: var(--blue);
}
.fare-amount {
  font-family: 'Share Tech Mono', monospace;
  font-size: 62px; line-height: 1; letter-spacing: -2px; color: var(--blue);
  text-shadow: 0 0 25px rgba(79,195,247,0.5), 0 0 50px rgba(79,195,247,0.2);
  transition: color 0.3s;
}
.fare-breakdown { margin-top: 5px; font-size: 11px; color: var(--muted); min-height: 14px; }
@keyframes fareFlash { 0%,100%{opacity:1} 50%{opacity:0.6} }
.fare-amount.ticking { animation: fareFlash 0.15s ease; }

/* â”€â”€ Stats â”€â”€ */
.stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 10px; }
.stat { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 8px 6px; text-align: center; }
.stat-label { font-size: 8px; letter-spacing: 3px; color: var(--muted); text-transform: uppercase; margin-bottom: 3px; }
.stat-value { font-family: 'Share Tech Mono', monospace; font-size: 14px; color: var(--text); }

/* â”€â”€ GPS bar â”€â”€ */
.gps-bar {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 12px; background: var(--surface); border: 1px solid var(--border);
  border-radius: 10px; margin-bottom: 10px;
}
.gps-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); transition: all 0.4s; flex-shrink: 0; }
.gps-dot.ok { background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{box-shadow:0 0 5px var(--green)} 50%{box-shadow:0 0 12px var(--green)} }
.gps-lbl { font-size: 9px; letter-spacing: 3px; color: var(--muted); flex-shrink: 0; font-weight: 600; }
.gps-msg { color: #777; flex: 1; font-size: 11px; }
.gps-switch { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }
.gps-switch input { opacity: 0; width: 0; height: 0; }
.gps-slider { position: absolute; cursor: pointer; inset: 0; background: #1a2030; border-radius: 22px; transition: 0.3s; border: 1px solid rgba(255,255,255,0.08); }
.gps-slider:before { content: ''; position: absolute; width: 16px; height: 16px; left: 2px; top: 2px; background: #444; border-radius: 50%; transition: 0.3s; }
input:checked + .gps-slider { background: rgba(46,204,113,0.2); border-color: var(--green); }
input:checked + .gps-slider:before { background: var(--green); transform: translateX(18px); box-shadow: 0 0 6px var(--green); }

/* â”€â”€ Rings â”€â”€ */
.rings { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 10px; }
.ring-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 10px; display: flex; align-items: center; gap: 10px; }
.ring-lbl { font-size: 8px; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; }
.ring-val { font-family: 'Share Tech Mono', monospace; font-size: 13px; color: var(--text); margin-top: 2px; }
.ring-pct { font-size: 10px; color: var(--muted); }
svg.ring { transform: rotate(-90deg); flex-shrink: 0; }
circle.ring-bg { fill: none; stroke: rgba(255,255,255,0.04); stroke-width: 5; }
circle.ring-fg { fill: none; stroke-width: 5; stroke-dasharray: 163.4; stroke-dashoffset: 163.4; stroke: var(--blue); transition: stroke-dashoffset 0.4s ease; stroke-linecap: round; }

/* â”€â”€ Section â”€â”€ */
.section-label { font-size: 8px; letter-spacing: 4px; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }

/* â”€â”€ Tariff â”€â”€ */
.tariff-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 10px; }
.tariff-btn { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 7px 4px; cursor: pointer; color: var(--muted); font-family: 'Rajdhani', sans-serif; font-size: 10px; letter-spacing: 1px; text-align: center; transition: all 0.2s; -webkit-appearance: none; }
.tariff-btn.active { background: rgba(79,195,247,0.08); border-color: rgba(79,195,247,0.5); color: var(--blue); }
.t-main { font-weight: 700; font-size: 13px; margin-bottom: 1px; }
.t-sub { font-size: 9px; }

/* â”€â”€ Extras â”€â”€ */
.extras { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 12px; }
.extra-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; }
.extra-label { font-size: 8px; letter-spacing: 3px; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
.extra-row { display: flex; align-items: center; gap: 6px; }
.extra-val { flex: 1; text-align: center; font-family: 'Share Tech Mono', monospace; font-size: 20px; color: var(--text); }
.extra-val.warn { color: var(--blue); }
.extra-note { font-size: 9px; color: var(--blue); margin-top: 4px; }
.adj-btn { width: 30px; height: 30px; border-radius: 7px; border: 1px solid var(--border); background: var(--surface2); color: #777; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; -webkit-appearance: none; transition: all 0.15s; }
.adj-btn:active { background: rgba(79,195,247,0.1); border-color: var(--blue); color: var(--blue); }

/* â”€â”€ Actions â”€â”€ */
.actions { display: flex; flex-direction: column; gap: 8px; }
.action-row { display: grid; gap: 8px; }
.big-btn { padding: 15px; border-radius: 12px; border: none; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 16px; letter-spacing: 4px; text-transform: uppercase; -webkit-appearance: none; transition: all 0.2s; width: 100%; }
.btn-start { background: linear-gradient(135deg, #4fc3f7, #0288d1); color: #050810; box-shadow: 0 4px 20px rgba(79,195,247,0.35); }
.btn-start:active { transform: scale(0.98); }
.btn-stop { background: rgba(231,76,60,0.1); color: var(--red); border: 1px solid rgba(231,76,60,0.4) !important; }
.btn-reset { background: var(--surface2); color: var(--muted); border: 1px solid var(--border) !important; }
.btn-new { background: transparent; color: var(--muted); border: 1px solid var(--border) !important; font-size: 13px; }

/* â”€â”€ Map overlay info â”€â”€ */
.map-overlay {
  position: absolute; top: 14px; left: 14px; z-index: 1000;
  background: rgba(8,11,15,0.85); backdrop-filter: blur(8px);
  border: 1px solid var(--border); border-radius: 12px;
  padding: 10px 14px; min-width: 160px;
}
.map-overlay-title { font-size: 9px; letter-spacing: 3px; color: var(--muted); margin-bottom: 6px; }
.map-stat { display: flex; justify-content: space-between; gap: 16px; margin-bottom: 3px; }
.map-stat-label { font-size: 10px; color: var(--muted); }
.map-stat-val { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: var(--blue); }

.map-centre-btn {
  position: absolute; bottom: 24px; right: 16px; z-index: 1000;
  width: 44px; height: 44px; border-radius: 10px;
  background: rgba(8,11,15,0.9); backdrop-filter: blur(8px);
  border: 1px solid var(--border); color: var(--blue);
  font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  -webkit-appearance: none;
}

/* Leaflet dark override */
.leaflet-tile { filter: brightness(0.7) saturate(0.6) hue-rotate(180deg) invert(1); }
.leaflet-container { background: #0a0e14; }
</style>
</head>
<body>
<div class="container">

  <!-- â”€â”€ METER PANEL â”€â”€ -->
  <div class="meter-panel">

    <div class="header">
      <div class="brand">
        <div class="brand-icon">ðŸš–</div>
        <div>
          <div class="brand-name">BLUELINE</div>
          <div class="brand-sub">North Yorkshire</div>
        </div>
      </div>
      <div class="status-pill" id="statusBadge">READY</div>
    </div>

    <div class="fare-wrap">
      <div class="fare-header">
        <div class="fare-label">Fare Due</div>
        <div class="tariff-badge" id="tariffBadge">TARIFF 1</div>
      </div>
      <div class="fare-amount" id="fareDisplay">Â£0.00</div>
      <div class="fare-breakdown" id="fareBreakdown"></div>
    </div>

    <div class="stats">
      <div class="stat"><div class="stat-label">Time</div><div class="stat-value" id="timeEl">00:00</div></div>
      <div class="stat"><div class="stat-label">Dist</div><div class="stat-value" id="distEl">0 yd</div></div>
      <div class="stat"><div class="stat-label">Speed</div><div class="stat-value" id="speedEl">0 mph</div></div>
    </div>

    <div class="rings">
      <div class="ring-card">
        <svg class="ring" width="62" height="62"><circle class="ring-bg" cx="31" cy="31" r="26"/><circle class="ring-fg" id="distRing" cx="31" cy="31" r="26"/></svg>
        <div><div class="ring-lbl">Next Dist</div><div class="ring-val" id="distIncVal">Â£0.20</div><div class="ring-pct" id="distPct">0%</div></div>
      </div>
      <div class="ring-card">
        <svg class="ring" width="62" height="62"><circle class="ring-bg" cx="31" cy="31" r="26"/><circle class="ring-fg" id="waitRing" cx="31" cy="31" r="26"/></svg>
        <div><div class="ring-lbl">Next Wait</div><div class="ring-val" id="waitIncVal">Â£0.20</div><div class="ring-pct" id="waitPct">0%</div></div>
      </div>
    </div>

    <div class="gps-bar">
      <div class="gps-dot" id="gpsDot"></div>
      <span class="gps-lbl">GPS</span>
      <span class="gps-msg" id="gpsMsg">Off â€” time only</span>
      <label class="gps-switch"><input type="checkbox" id="gpsToggle" onchange="toggleGps(this.checked)"><span class="gps-slider"></span></label>
    </div>

    <div class="section-label">Tariff</div>
    <div class="tariff-grid">
      <button class="tariff-btn active" data-t="1" onclick="selectTariff(1)"><div class="t-main">T1</div><div class="t-sub">Â£4.00</div><div class="t-sub">+Â£0.20</div></button>
      <button class="tariff-btn" data-t="2" onclick="selectTariff(2)"><div class="t-main">T2</div><div class="t-sub">Â£5.40</div><div class="t-sub">+Â£0.30</div></button>
      <button class="tariff-btn" data-t="3" onclick="selectTariff(3)"><div class="t-main">T3</div><div class="t-sub">Â£7.20</div><div class="t-sub">+Â£0.40</div></button>
    </div>

    <div class="extras">
      <div class="extra-card">
        <div class="extra-label">Passengers</div>
        <div class="extra-row"><button class="adj-btn" onclick="adjPax(-1)">âˆ’</button><div class="extra-val" id="paxVal">1</div><button class="adj-btn" onclick="adjPax(1)">+</button></div>
        <div class="extra-note" id="paxNote" style="display:none">+Â£1.00/head</div>
      </div>
      <div class="extra-card">
        <div class="extra-label">Call-Out (mi)</div>
        <div class="extra-row"><button class="adj-btn" onclick="adjCallout(-0.5)">âˆ’</button><div class="extra-val" id="calloutVal">0.0</div><button class="adj-btn" onclick="adjCallout(0.5)">+</button></div>
        <div class="extra-note" id="calloutNote" style="display:none"></div>
      </div>
    </div>

    <div class="actions" id="actions">
      <button class="big-btn btn-start" onclick="startMeter()">â–¶  Start Journey</button>
    </div>

  </div>

  <!-- â”€â”€ MAP PANEL â”€â”€ -->
  <div class="map-panel">
    <div id="map"></div>

    <!-- Map overlay stats -->
    <div class="map-overlay">
      <div class="map-overlay-title">LIVE POSITION</div>
      <div class="map-stat"><span class="map-stat-label">Speed</span><span class="map-stat-val" id="mapSpeed">0 mph</span></div>
      <div class="map-stat"><span class="map-stat-label">Heading</span><span class="map-stat-val" id="mapHeading">â€”</span></div>
      <div class="map-stat"><span class="map-stat-label">Distance</span><span class="map-stat-val" id="mapDist">0 yd</span></div>
    </div>

    <button class="map-centre-btn" onclick="centreMap()" title="Centre map">âŠ•</button>
  </div>

</div>

<script>
// â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TARIFFS={1:{flagFall:4.00,increment:0.20,label:'TARIFF 1'},2:{flagFall:5.40,increment:0.30,label:'TARIFF 2'},3:{flagFall:7.20,increment:0.40,label:'TARIFF 3'}};
const DIST_PER_INC_M=153.28,FLAG_FALL_M=402.34,TIME_PER_INC_S=37.36,WAIT_MPH=0.5,CIRC=163.4,GPS_STALE_S=3;

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tariffKey=autoTariff(),passengers=1,callout=0,running=false,gpsEnabled=false;
let fare=0,distM=0,elapsedS=0,speedMph=0,heading=null;
let distAcc=0,waitAcc=0,lastPos=null,watchId=null,tickTimer=null,lastGpsUpdate=0;

// â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([53.9915, -1.5412], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
L.control.zoom({ position: 'bottomright' }).addTo(map);

// Car marker
const carIcon = L.divIcon({
  className: '',
  html: `<div style="width:18px;height:18px;background:#4fc3f7;border:3px solid #fff;border-radius:50%;box-shadow:0 0 12px rgba(79,195,247,0.8)"></div>`,
  iconSize: [18, 18], iconAnchor: [9, 9]
});
let carMarker = L.marker([53.9915, -1.5412], { icon: carIcon }).addTo(map);
let routeLine = L.polyline([], { color: '#4fc3f7', weight: 4, opacity: 0.8 }).addTo(map);
let routeCoords = [];
let mapLocked = true;

function centreMap() { mapLocked = true; if (lastPos) map.setView([lastPos.lat, lastPos.lon], 16); }

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function autoTariff(){return new Date().getHours()>=6?1:2;}
function haversineM(la1,lo1,la2,lo2){const R=6371000,p1=la1*Math.PI/180,p2=la2*Math.PI/180,dp=(la2-la1)*Math.PI/180,dl=(lo2-lo1)*Math.PI/180,a=Math.sin(dp/2)**2+Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}
function fmtTime(s){return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');}
function fmtDist(m){const mi=m/1609.34;return mi>=0.1?mi.toFixed(2)+' mi':Math.round(m*1.09361)+' yd';}
function money(n){return 'Â£'+n.toFixed(2);}
function rgba(hex,a){return `rgba(${parseInt(hex.slice(1,3),16)},${parseInt(hex.slice(3,5),16)},${parseInt(hex.slice(5,7),16)},${a})`;}
function headingStr(h){if(h===null)return 'â€”';const dirs=['N','NE','E','SE','S','SW','W','NW'];return dirs[Math.round(h/45)%8]+' '+Math.round(h)+'Â°';}

// Unlock map pan
map.on('dragstart', () => mapLocked = false);

// â”€â”€ GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleGps(on){
  gpsEnabled=on;
  if(on){
    if(!navigator.geolocation){setGpsUI(false,'Not available');document.getElementById('gpsToggle').checked=false;gpsEnabled=false;return;}
    setGpsUI(false,'Requesting permissionâ€¦');
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        setGpsUI(true,'Signal acquired');
        const{latitude:lat,longitude:lon}=pos.coords;
        map.setView([lat,lon],16);
        carMarker.setLatLng([lat,lon]);
        if(running)startWatch();
      },
      ()=>{setGpsUI(false,'Permission denied');document.getElementById('gpsToggle').checked=false;gpsEnabled=false;},
      {enableHighAccuracy:true,timeout:15000}
    );
  }else{stopWatch();speedMph=0;heading=null;lastPos=null;document.getElementById('gpsDot').className='gps-dot';setGpsUI(false,'Off â€” time only');}
}

function startWatch(){if(!gpsEnabled||!navigator.geolocation)return;watchId=navigator.geolocation.watchPosition(onPos,onGpsErr,{enableHighAccuracy:true,maximumAge:500,timeout:15000});}
function stopWatch(){if(watchId!==null){navigator.geolocation.clearWatch(watchId);watchId=null;}}

function onPos(pos){
  setGpsUI(true,'Signal acquired');lastGpsUpdate=Date.now();
  const{latitude:lat,longitude:lon,speed:spd,heading:hdg}=pos.coords;
  const mph=spd!=null?spd*2.23694:0;
  speedMph=+mph.toFixed(1);
  heading=hdg;

  // Update map
  carMarker.setLatLng([lat,lon]);
  if(mapLocked)map.setView([lat,lon],map.getZoom());

  if(!running){lastPos={lat,lon};return;}

  if(lastPos){
    const d=haversineM(lastPos.lat,lastPos.lon,lat,lon);
    distM+=d;
    if(mph>WAIT_MPH&&distM>FLAG_FALL_M){
      distAcc+=d;
      while(distAcc>=DIST_PER_INC_M){distAcc-=DIST_PER_INC_M;addIncrement();}
    }
    // Add to route
    routeCoords.push([lat,lon]);
    routeLine.setLatLngs(routeCoords);
  }
  lastPos={lat,lon};
  render();
}
function onGpsErr(){setGpsUI(false,'Signal lost');}
function setGpsUI(ok,msg){document.getElementById('gpsDot').className='gps-dot'+(ok?' ok':'');document.getElementById('gpsMsg').textContent=msg;}

// â”€â”€ Meter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addIncrement(){
  fare=+(fare+TARIFFS[tariffKey].increment).toFixed(2);
  const el=document.getElementById('fareDisplay');
  el.classList.remove('ticking');void el.offsetWidth;el.classList.add('ticking');
}

function startTick(){
  tickTimer=setInterval(()=>{
    if(!running)return;elapsedS++;
    const stale=gpsEnabled&&(Date.now()-lastGpsUpdate>GPS_STALE_S*1000);
    if(speedMph<=WAIT_MPH||stale){waitAcc++;if(waitAcc>=TIME_PER_INC_S){waitAcc-=TIME_PER_INC_S;addIncrement();}}
    render();
  },1000);
}
function stopTick(){if(tickTimer){clearInterval(tickTimer);tickTimer=null;}}

function startMeter(){
  fare=TARIFFS[tariffKey].flagFall;distM=0;elapsedS=0;speedMph=0;heading=null;
  distAcc=0;waitAcc=0;lastPos=null;lastGpsUpdate=Date.now();
  routeCoords=[];routeLine.setLatLngs([]);
  running=true;
  setStatus('HIRED','#2ecc71','rgba(46,204,113,0.12)','rgba(46,204,113,0.35)');
  if(gpsEnabled)startWatch();startTick();renderActions();render();
}
function stopMeter(){
  running=false;stopTick();stopWatch();
  setStatus('COMPLETE','#f5a623','rgba(245,166,35,0.12)','rgba(245,166,35,0.35)');
  renderActions();render();
}
function resetMeter(){
  running=false;stopTick();stopWatch();
  fare=0;distM=0;elapsedS=0;speedMph=0;heading=null;distAcc=0;waitAcc=0;
  routeCoords=[];routeLine.setLatLngs([]);
  tariffKey=autoTariff();passengers=1;callout=0;
  setStatus('READY','#3a4255','rgba(58,66,85,0.3)','rgba(255,255,255,0.07)');
  setGpsUI(false,gpsEnabled?'Ready':'Off â€” time only');
  renderActions();renderTariff();renderExtras();render();
}
function setStatus(t,c,b,br){const el=document.getElementById('statusBadge');el.textContent=t;el.style.color=c;el.style.background=b;el.style.borderColor=br;}
function selectTariff(k){if(running)return;tariffKey=k;renderTariff();render();}
function adjPax(d){passengers=Math.min(10,Math.max(1,passengers+d));renderExtras();render();}
function adjCallout(d){callout=Math.max(0,+(callout+d).toFixed(1));renderExtras();render();}

function renderTariff(){
  document.querySelectorAll('.tariff-btn').forEach(btn=>{
    const k=parseInt(btn.dataset.t),active=k===tariffKey;
    btn.className='tariff-btn'+(active?' active':'');btn.disabled=running;btn.style.opacity=running?0.5:1;
  });
  document.getElementById('tariffBadge').textContent=TARIFFS[tariffKey].label;
}
function renderExtras(){
  const pv=document.getElementById('paxVal');pv.textContent=passengers;pv.className='extra-val'+(passengers>=5?' warn':'');
  document.getElementById('paxNote').style.display=passengers>=5?'':'none';
  const cc=callout>1?callout-1:0,cv=document.getElementById('calloutVal');
  cv.textContent=callout.toFixed(1);cv.className='extra-val'+(callout>1?' warn':'');
  const cn=document.getElementById('calloutNote');
  if(callout>1){cn.textContent='+Â£'+cc.toFixed(2)+' callout';cn.style.display='';}else{cn.style.display='none';}
}
function renderActions(){
  const el=document.getElementById('actions');
  if(running){el.innerHTML=`<div class="action-row" style="grid-template-columns:1fr 1fr"><button class="big-btn btn-stop" onclick="stopMeter()">â–   Stop</button><button class="big-btn btn-reset" onclick="resetMeter()">â†º  Reset</button></div>`;}
  else{el.innerHTML=`<button class="big-btn btn-start" onclick="startMeter()">â–¶  Start Journey</button>`+(fare>0?`<button class="big-btn btn-new" onclick="resetMeter()" style="margin-top:8px">â†º  New Journey</button>`:'');}
}

function render(){
  const t=TARIFFS[tariffKey],pc=passengers>=5?passengers:0,cc=callout>1?callout-1:0,total=+(fare+pc+cc).toFixed(2);
  document.getElementById('fareDisplay').textContent=money(total);
  const parts=[];if(pc>0||cc>0){parts.push('Meter: '+money(fare));if(pc>0)parts.push('Pax: '+money(pc));if(cc>0)parts.push('Callout: '+money(cc));}
  document.getElementById('fareBreakdown').textContent=parts.join('  Â·  ');
  document.getElementById('timeEl').textContent=fmtTime(elapsedS);
  document.getElementById('distEl').textContent=fmtDist(distM);
  document.getElementById('speedEl').textContent=speedMph+' mph';
  const dp=Math.min(distM>FLAG_FALL_M?distAcc/DIST_PER_INC_M:0,1),wp=Math.min(waitAcc/TIME_PER_INC_S,1);
  document.getElementById('distRing').style.strokeDashoffset=CIRC*(1-dp);
  document.getElementById('waitRing').style.strokeDashoffset=CIRC*(1-wp);
  document.getElementById('distIncVal').textContent=money(t.increment);
  document.getElementById('waitIncVal').textContent=money(t.increment);
  document.getElementById('distPct').textContent=(dp*100).toFixed(0)+'%';
  document.getElementById('waitPct').textContent=(wp*100).toFixed(0)+'%';
  // Map overlay
  document.getElementById('mapSpeed').textContent=speedMph+' mph';
  document.getElementById('mapHeading').textContent=headingStr(heading);
  document.getElementById('mapDist').textContent=fmtDist(distM);
}

// Init
renderTariff();renderExtras();render();
</script>
</body>
</html>
